<apex:page Controller="CNT_TPA_AMAOffshoreTemplate_Revised" cache="false" sideBar="false" showHeader="false" standardstylesheets="false" lightningStylesheets="true"> 
    <apex:slds /> 
    <script type="text/javascript">
        console.log('currentLoggedInUserProfile0::::'+'{!currentUserProfileName}');
        function getUrlVars() {
        var vars = {}, hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars[hash[0]] = hash[1];
        }
        return vars;
		}
        console.log('currentLoggedInUserProfile::::'+'{!currentUserProfileName}');
        if('{!currentUserProfileName}' == 'tpa Profile') {
            var qryString = '';
            var urlParams = getUrlVars();
            for(var key in urlParams) {
                if(urlParams.hasOwnProperty(key)) {
                    var val = urlParams[key];
                    qryString += key + '=' + val + '&';
                }
            }
            console.log('quryString-1:::'+JSON.stringify(urlParams));
            console.log('quryString:::'+qryString);
            qryString = qryString.slice(0, -1);
            console.log('quryString0:::'+qryString);
            console.log('quryString1:::'+'{!tpaCommunityUrl}');
            window.location.href = '{!tpaCommunityUrl}' + '/VFP_TPA_ExternalUserAction?actionType=tpasitelinkaccess&returlpage=VFP_TPA_AMAOffshoreTemplate_Revised&' + qryString;
        }
    </script>
    <!-- Added for site to community logic submission end-->
    <apex:outputPanel rendered="{!IF(currentUserProfileName != 'tpa Profile',True, False)}">

    <html>
        <head>
            <meta http-equiv="X-UA-Compatible" content="IE=9" />
            <meta http-equiv="X-UA-Compatible" content="IE=edge"/> 
            <!-- Added for site to community logic submission start -->
                 
            <!-- stylesheet for new style tab -->
            <apex:stylesheet value="/sCSS/52.0/sprites/1297816277000/Theme3/default/gc/versioning.css" />     
            
            <!-- *** Angular-JS Library reference ** -->
            <apex:includeScript value="{!$Resource.AngularJS}"/>
            <!-- *** Angular-JS Library reference ** -->
            
            <!-- *** Angular-JS Bootstrap Modal Pop Up Library reference ** -->
            <script src="{!$Resource.AngularUiBootstrap}" type="text/javascript"></script>
            <!-- *** Angular-JS Bootstrap Modal Pop Up Library reference ** -->
                
                <!-- *** Library reference to fill controlling and dependent picklist from api by making client side call *** -->
                    <script src="/soap/ajax/52.0/connection.js" type="text/javascript"></script>
            <script src="/soap/ajax/52.0/apex.js" type="text/javascript"></script>
            <!-- *** Library reference to fill controlling and dependent picklist from api by making client side call *** -->
                
                <!-- *** Jquery library reference *** -->
                    <script src="{!$Resource.TPAJquery}" type="text/javascript"></script>
            <!-- *** Jquery library reference *** -->  
            
            <script src="{!$Resource.TpaJQueryCookie}" type="text/javascript"></script><!-- Added by C.P.Pandey under CR-7565 -->
            
            <!-- *** JQuery UI Library reference *** -->
                <script src="{!$Resource.TPAJqueryUI}" type="text/javascript"></script>
            <!-- *** JQuery UI Library reference *** -->
            <script src="{!$Resource.BootstrapJS}" type="text/javascript"></script>
            <!-- *** Multi Select Control Javascript Library reference *** -->
            <script src="{!URLFOR($Resource.TpaMultiSelect, 'select2.js')}" type="text/javascript"></script>
            <!-- *** Multi Select Control Javascript Library reference *** -->
            
            <link href="{!URLFOR($Resource.TpaCustomPopup, 'popup.css')}" rel="stylesheet" type="text/css" />
    		<script src="{!URLFOR($Resource.TpaCustomPopup, 'popup.js')}" type="text/javascript" />
            <style>
            
            table {
                font-family: arial, sans-serif;
                width: 100%;
            }
            
            td, th {
                text-align: left;
                padding: 8px;
            }
            
            p.indent { 
                padding-left: 1.8em 
            }
            
            .labelText {
                color:#4a4a56;
                font-weight:bold;
            }
            .headingText {
                color: #000;
                font-size: 1.3em;
            }
            /**** Error Message Style Start ****/
            .message .messageText h4
            {
                font-size:20px;
                margin-left: 30px;
            }
            
            .message ul li
            {
                list-style:disc;
            }
            
            .textbox { 
                background: white; 
                border: 1px solid #DDD; 
                border-radius: 5px; 
                box-shadow: 0 0 5px #DDD inset; 
                color: #666; 
                outline: none; 
                height:25px; 
                width: 275px; 
            } 
            
            .vertical-line { 
                border-left:medium #CC0000 solid;
                margin-right:1px;
            }
            
            #menu { 
            padding:0; 
            margin-Left:0;
            margin-Top:20px; 
            }
            
            #menu li { 
            margin-Top:5px;
            margin-left:100px;
            } 
            
            div {
                text-align: justify;
            }
            pre{
                margin:0px;
                font-family: Arial !important;
            }
            /**** Error Message Style End ****/
            </style>       
            <script type="text/javascript">
                
            <!-- Angular JS Application Name -->
                var myapp = angular.module('AMARevisedOffshoreProcess', ['ui.bootstrap']);
            
            <!-- Page Controller Start -->
                var contrl = myapp.controller('controllerPage',['$scope', '$location', '$filter', '$modal', '$log', '$window', function ($scope, $location, $filter, $modal, $log, $window) {
					<!-- Initialize Services -->
						$scope.$log = $log;
					<!-- Initialize Services -->
						$scope.rootObject = {};
					$scope.rootObject.viewMode = '';
					$scope.rootObject.type = '';
					
					$scope.rootObject.amaAgreementObj = {};
					$scope.rootObject.amaAgreementObj.id = '';
					$scope.rootObject.amaAgreementObj.Vendor_Contact_Name__c = '';  // vendor contact name
					$scope.rootObject.amaAgreementObj.Client__c = '';  // Client name
					$scope.rootObject.amaAgreementObj.TPA_Request__c = '';  // tpa Request id
					
					$scope.rootObject.amaAgreementObj.Vendor_Legal_Name__c = '';   // vendor Legal Name
					$scope.rootObject.amaAgreementObj.Contract_Type__c = ''; // contract type
					$scope.rootObject.amaAgreementObj.Agreement_Start_Date__c = '';   // Agreement Start Date
					$scope.rootObject.amaAgreementObj.Initial_Termination_Date__c = '';  // Initial Termination Date
					$scope.rootObject.amaAgreementObj.Agreement_End_Date__c = '';    // Agreement End Date
					$scope.rootObject.amaAgreementObj.AMA_TypeOfPrescriberLevelData__c ='';   // AMA Variables Requested
					$scope.rootObject.amaAgreementObj.AMA_Services_Provided__c = '';  // AMA Project USEs
					$scope.rootObject.amaAgreementObj.AMA_Howlong_SP_has_Data_Access__c = '';   // How long will Vendor have access to Data
					$scope.rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name__c = '';
					
					$scope.rootObject.amaAgreementObj.Vendor_require_Remote_Access_from_NonUS__c = '';
                    $scope.rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name_Remote_Access__c = '';
                    $scope.rootObject.amaAgreementObj.Vendor_Employee_Accessed_Data_in_country__c = '';
                    $scope.rootObject.amaAgreementObj.Technology_s_selected_for_remote_access__c = '';
                    $scope.rootObject.amaAgreementObj.Other_Technology_for_Remote_Access__c = '';
                    $scope.rootObject.amaAgreementObj.Vendor_req_Storage_Permission_from_NonUS__c = '';
                    $scope.rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name_Offshore_Storage__c = '';
                    $scope.rootObject.amaAgreementObj.Vendor_Employee_Store_Data_in_country__c = '';
					
					<!-- Offshore Values -->
						$scope.rootObject.amaAgreementObj.Status_of_Offshore_Process__c = '';
					$scope.rootObject.amaAgreementObj.Technologies_to_access_AMA_PPD_by_vendor__c = '';
					$scope.rootObject.amaAgreementObj.Other_technology_to_access_AMA_PPD__c = '';
					$scope.rootObject.amaAgreementObj.Vendor_employee_access_data_in_country__c = '';
					$scope.rootObject.amaAgreementObj.Vendor_Name_who_requested_offshore__c = '';
					$scope.rootObject.amaAgreementObj.Title_for_vendor_who_requested_offshore__c = '';
					$scope.rootObject.amaAgreementObj.Date_vendor_responded_for_offshore__c = '';
					
					<!-- DBL Values -->
						$scope.rootObject.AMAResponseforOffshore = '';
					$scope.rootObject.amaAgreementObj.Questions_for_Vendor_Response__c = '';
					$scope.rootObject.amaAgreementObj.AMA_reasons_why_offshore_not_approved__c = '';
					
					<!--other values -->
						$scope.rootObject.Agreement_file_Name = '';
					$scope.rootObject.TPA_Request_number = ''; // tpa Request id
					$scope.rootObject.vendorCompanyName = '';   // vendor company name
					$scope.rootObject.accessTechnologyList = {!TechnologyToAccessAMAPPDList};
					$scope.rootObject.technologiesValues = [];
					
					$scope.rootObject.MsgShow = 'false';
					$scope.rootObject.offshoreErrorMessage = '';
					$scope.rootObject.offshoreSuccessMessage = '';
					$scope.rootObject.isProcessing = false;					
					
					<!--Populating TPA AMA Agreement Detail Values for Offshore Form -->
					$scope.rootObject.amaAgreementDetailObject = JSON.parse('{!JSENCODE(amaAgreementDetailAsString)}');
																				
					$scope.rootObject.onLoadForm = function() {
						//Shut down popup code start
                        var isPermanentDown = {!isTPAPermanentDown};
        				var isRestrictedUser = {!isRestrictedUser};
        				var portalDownMessage = '{!Message}';
        				$(document).ready(function(){
            				if(isPermanentDown)
                            {
                                popupAlert(portalDownMessage)
                                    $('.customPopupFooter .aButtons').css("display","none");
                                    $('#backWhiteOverlay').css("display", "");
                                    $('#pageBody').keydown(function(objEvent) {
                                        if (objEvent.keyCode == 9) {  //tab pressed
                                            objEvent.preventDefault(); // stops its action
                                        }
                                        if (objEvent.keyCode == 13) {  //enter pressed
                                            objEvent.preventDefault(); // stops its action
                                        }
                                    });
                            }
        				});
                		//shut down popup code end
						
						if(getParameterByName('viewMode').trim().length > 0 )
						{
							$scope.rootObject.viewMode = getParameterByName('viewMode').trim();
						}
						
						if(getParameterByName('type').trim().length > 0 ){
							
							$scope.rootObject.type = getParameterByName('type').trim();
						}
						
						if($scope.rootObject.viewMode  != null && $scope.rootObject.viewMode == 'offshore'&& $scope.rootObject.type != null && ($scope.rootObject.type == 'VSubmit' || $scope.rootObject.type == 'DBLSubmit'|| $scope.rootObject.type == 'TpUsRequest'))
						{							
							if($scope.rootObject.type == 'TpUsRequest') {
								
								$scope.rootObject.amaAgreementObj.id = $scope.rootObject.amaAgreementDetailObject.Id;
							}
							else if($scope.rootObject.type == 'VSubmit' && $scope.rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  != 'Awaiting Vendor Response: AMA Offshore Consent form has been sent to Vendor') {
								$scope.rootObject.offshoreErrorMessage = 'Sorry, you have already submitted your response.';
							}
							else if($scope.rootObject.type == 'DBLSubmit' && $scope.rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  != 'Awaiting AMA Response: Offshore Consent form requires AMA review/approval') {
								$scope.rootObject.offshoreErrorMessage = 'Sorry, you have already submitted your response.';
							}
							else if($scope.rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  != 'Awaiting Vendor Response: AMA Offshore Consent form has been sent to Vendor' && $scope.rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c != 'Awaiting AMA Response: Offshore Consent form requires AMA review/approval') {
								
								$scope.rootObject.offshoreErrorMessage = 'Sorry, you are not authorized to access this page.';
							}
							else
							{
								$scope.rootObject.amaAgreementObj.id = $scope.rootObject.amaAgreementDetailObject.Id;
								$scope.rootObject.Agreement_file_Name = $scope.rootObject.amaAgreementDetailObject.TPA_Request__r.Name;
								$scope.rootObject.amaAgreementObj.Vendor_Contact_Name__c = $scope.rootObject.amaAgreementDetailObject.Vendor_Contact_Name__c;
								$scope.rootObject.vendorCompanyName = $scope.rootObject.amaAgreementDetailObject.TPA_Request__r.Vendor_Company_Name__c;
								$scope.rootObject.amaAgreementObj.Client__c = $scope.rootObject.amaAgreementDetailObject.Client__c;
								$scope.rootObject.amaAgreementObj.TPA_Request__c = $scope.rootObject.amaAgreementDetailObject.TPA_Request__c;
								$scope.rootObject.TPA_Request_number = $scope.rootObject.amaAgreementDetailObject.TPA_Request__r.Name;
								
								$scope.rootObject.amaAgreementObj.Vendor_Legal_Name__c = $scope.rootObject.amaAgreementDetailObject.Vendor_Legal_Name__c;
								$scope.rootObject.amaAgreementObj.Contract_Type__c  = $scope.rootObject.amaAgreementDetailObject.Contract_Type__c;
								$scope.rootObject.amaAgreementObj.Agreement_Start_Date__c = $scope.rootObject.amaAgreementDetailObject.Agreement_Start_Date__c;
								$scope.rootObject.amaAgreementObj.Initial_Termination_Date__c = $scope.rootObject.amaAgreementDetailObject.Initial_Termination_Date__c;
								$scope.rootObject.amaAgreementObj.Agreement_End_Date__c = $scope.rootObject.amaAgreementDetailObject.Agreement_End_Date__c;
								$scope.rootObject.amaAgreementObj.AMA_TypeOfPrescriberLevelData__c = $scope.rootObject.amaAgreementDetailObject.AMA_TypeOfPrescriberLevelData__c;
								$scope.rootObject.amaAgreementObj.AMA_Services_Provided__c = $scope.rootObject.amaAgreementDetailObject.AMA_Services_Provided__c;
								$scope.rootObject.amaAgreementObj.AMA_Howlong_SP_has_Data_Access__c = $scope.rootObject.amaAgreementDetailObject.AMA_Howlong_SP_has_Data_Access__c;
								$scope.rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name__c = $scope.rootObject.amaAgreementDetailObject.Ex_US_Legal_Entity_Name__c;
								
								$scope.rootObject.amaAgreementObj.Vendor_require_Remote_Access_from_NonUS__c = $scope.rootObject.amaAgreementDetailObject.Vendor_require_Remote_Access_from_NonUS__c;
                                $scope.rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name_Remote_Access__c = $scope.rootObject.amaAgreementDetailObject.Ex_US_Legal_Entity_Name_Remote_Access__c;
                                $scope.rootObject.amaAgreementObj.Vendor_Employee_Accessed_Data_in_country__c = $scope.rootObject.amaAgreementDetailObject.Vendor_Employee_Accessed_Data_in_country__c;
                                $scope.rootObject.amaAgreementObj.Technology_s_selected_for_remote_access__c = $scope.rootObject.amaAgreementDetailObject.Technology_s_selected_for_remote_access__c;
                                $scope.rootObject.amaAgreementObj.Other_Technology_for_Remote_Access__c = $scope.rootObject.amaAgreementDetailObject.Other_Technology_for_Remote_Access__c;
                                $scope.rootObject.amaAgreementObj.Vendor_req_Storage_Permission_from_NonUS__c = $scope.rootObject.amaAgreementDetailObject.Vendor_req_Storage_Permission_from_NonUS__c;
                                $scope.rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name_Offshore_Storage__c = $scope.rootObject.amaAgreementDetailObject.Ex_US_Legal_Entity_Name_Offshore_Storage__c;
                                $scope.rootObject.amaAgreementObj.Vendor_Employee_Store_Data_in_country__c = $scope.rootObject.amaAgreementDetailObject.Vendor_Employee_Store_Data_in_country__c;
								
								$scope.rootObject.amaAgreementObj.Status_of_Offshore_Process__c = $scope.rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c;
								$scope.rootObject.amaAgreementObj.Vendor_employee_access_data_in_country__c = $scope.rootObject.amaAgreementDetailObject.Vendor_employee_access_data_in_country__c;
								
								if($scope.rootObject.type == 'VSubmit') {
									$scope.rootObject.amaAgreementObj.Date_vendor_responded_for_offshore__c  = $filter('date')(new Date(),'MM/dd/yyyy');
									
								} else if($scope.rootObject.type == 'DBLSubmit') {
									
									$scope.rootObject.amaAgreementObj.Technologies_to_access_AMA_PPD_by_vendor__c = $scope.rootObject.amaAgreementDetailObject.Technologies_to_access_AMA_PPD_by_vendor__c;
									$scope.rootObject.amaAgreementObj.Other_technology_to_access_AMA_PPD__c = $scope.rootObject.amaAgreementDetailObject.Other_technology_to_access_AMA_PPD__c;
									$scope.rootObject.amaAgreementObj.Vendor_Name_who_requested_offshore__c = $scope.rootObject.amaAgreementDetailObject.Vendor_Name_who_requested_offshore__c;
									$scope.rootObject.amaAgreementObj.Title_for_vendor_who_requested_offshore__c = $scope.rootObject.amaAgreementDetailObject.Title_for_vendor_who_requested_offshore__c;
									
									if($scope.rootObject.amaAgreementObj.Technologies_to_access_AMA_PPD_by_vendor__c != '' && $scope.rootObject.amaAgreementObj.Technologies_to_access_AMA_PPD_by_vendor__c != null) {
										$scope.rootObject.technologiesValues = $scope.rootObject.amaAgreementObj.Technologies_to_access_AMA_PPD_by_vendor__c.split(';');
									}
									if($scope.rootObject.amaAgreementDetailObject.Date_vendor_responded_for_offshore__c != '' || $scope.rootObject.amaAgreementDetailObject.Date_vendor_responded_for_offshore__c != null) {
										$scope.rootObject.amaAgreementObj.Date_vendor_responded_for_offshore__c  = $filter('date')(new Date($scope.rootObject.amaAgreementDetailObject.Date_vendor_responded_for_offshore__c),'MM/dd/yyyy');
									}
									
								}
							}							
						} else {							
							$scope.rootObject.offshoreErrorMessage = 'Sorry, you are not authorized to access this page.';
						}						
					}
					
					$scope.rootObject.onLoadForm();					
					
					if($scope.rootObject.viewMode == 'offshore' && $scope.rootObject.type == 'TpUsRequest')
					{						
						CNT_TPA_AMAOffshoreTemplate_Revised.tpUsReqSendQuesTOVendor($scope.rootObject.amaAgreementObj.id,function(result, event)
							{
								if(event.type == 'exception')
								{
									hideLoading();                                
									$scope.$log.info('Exception: ' + event.message);
									return false;                                    
								}
								else if(result != null && result == true )
								{
									window.location.href = '/' + getParameterByName('id');
								}
									else
									{
										hideLoading();                                
										$scope.$log.info('Event Type: ' + event.type);
										return false;
									}
								if(!$scope.$$phase) {
									//$digest or $apply
									$scope.$apply();
								}
								hideLoading();
							},
							{escape: false}
						);						
					}
					
					
					$scope.rootObject.saveAMAResponse = function(){						
						if($scope.rootObject.AMAResponseforOffshore == null || $scope.rootObject.AMAResponseforOffshore == '') {							
							$scope.popupAlert('Please provide your AMA response' , function(){});
							return false;
						}
						
						if($scope.rootObject.AMAResponseforOffshore == 'Additional questions for Vendor' && ( $scope.rootObject.amaAgreementObj.Questions_for_Vendor_Response__c == null || $scope.rootObject.amaAgreementObj.Questions_for_Vendor_Response__c =='')) {							
							$scope.popupAlert('Please provide Additional Information' , function(){});
							return false;
						}
						
						if($scope.rootObject.AMAResponseforOffshore == 'not approved' && ($scope.rootObject.amaAgreementObj.AMA_reasons_why_offshore_not_approved__c =='' || $scope.rootObject.amaAgreementObj.AMA_reasons_why_offshore_not_approved__c == null)) {
							
							$scope.popupAlert('Please provide the Reason for not approval' , function(){});
							return false;
						}
						
						$scope.rootObject.amaObject = {};
						
						$scope.rootObject.amaObject.id = $scope.rootObject.amaAgreementObj.id;
						$scope.rootObject.amaObject.Questions_for_Vendor_Response__c =  $scope.rootObject.amaAgreementObj.Questions_for_Vendor_Response__c;
						$scope.rootObject.amaObject.AMA_reasons_why_offshore_not_approved__c =  $scope.rootObject.amaAgreementObj.AMA_reasons_why_offshore_not_approved__c;
						
						$scope.rootObject.isProcessing = true;
						$('#el_loading').css('display','block');
						
						CNT_TPA_AMAOffshoreTemplate_Revised.saveAMAResponseForOffshore($scope.rootObject.AMAResponseforOffshore,JSON.stringify($scope.rootObject.amaObject),function(result, event) { <!-- modified by Supriya Johari under ER-3888 -->
							
							if(event.type == 'exception')
							{
								hideLoading();                                
								$scope.$log.info('Exception: ' + event.message);
								$scope.rootObject.isProcessing = false;
								return false;                                    
							}else if(result != null && result == 'success'){
								$scope.rootObject.offshoreSuccessMessage = 'Thank you, your response has been submitted to IQVIA.';
								angular.element($('#controllerPage')).scope().applyChanges();
                                if('{!currentUserProfileName}' == 'TPA Vendor Community User') {
                                    logoutSession();
                                }
								return true;
							}else if(result != null && result == 'alreadySubmittedResponse'){
								 $scope.rootObject.offshoreErrorMessage = 'Sorry, you have already submitted your response.';;
								 angular.element($('#controllerPage')).scope().applyChanges();
                                 if('{!currentUserProfileName}' == 'TPA Vendor Community User') {
                                    logoutSession();
                                 }
								 return true;
							 }else{
								 $scope.rootObject.isProcessing = false;
								 hideLoading();                            
								 $scope.$log.info('Event Type: ' + result);
                                 if('{!currentUserProfileName}' == 'TPA Vendor Community User') {
                                    logoutSession();
                                 }
								 return false;
							 }
							 if(!$scope.$$phase) {
								 //$digest or $apply
								 $scope.$apply();
							 }
							 hideLoading();
						},
						{escape: false});
					}
					
					$scope.popupAlert = function(msg, truePart)
					{
						popup(msg, {'animate':true}, 
						function(r)
						{
							if(r && truePart != null)
								truePart();
						});
					}
					
					$scope.getFormattedValue = function(label){
						var addText = label;
						if(addText!= null && addText!= '')
							return addText.split(';').join(', ');
						else
							return addText;
					};
					
					
					
					$scope.updateTechnologyToaccess = function(technology){
						if($scope.rootObject.technologiesValues.indexOf(technology) == -1){
							$scope.rootObject.technologiesValues.push(technology);
						} 
						else{
							$scope.rootObject.technologiesValues.splice($scope.rootObject.technologiesValues.indexOf(technology),1);
						}
					};
					
					
					//****** Angular Apply All Changes Event Start ******//
					//*** function triggers and applies all angular scope changes explicitly ***//
					$scope.applyChanges = function()
					{
						if ($scope.$root.$$phase != '$apply' && $scope.$root.$$phase != '$digest')
							$scope.$apply();
					}
					//****** Angular Apply All Changes Event End ******//
					
					
					//*** function to read Query strings Start ***//
					function getParameterByName(name) 
					{
						name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
						var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"), results = regex.exec(location.search);
						return results == null ? "" : results[1].replace(/\+/g, " ");
					}
					//*** function to read Query strings End ***//
                    //Added for site to community logic submission start
                    function logoutSession() {
                        console.log('BeforeAjaxCall:::');
                        $.ajax('{!$Site.Prefix}/secur/logout.jsp',{
                            type:'POST',
                            beforeSend: function(xhr) {
                                // Set the OAuth header from the session ID
                                xhr.setRequestHeader('Authorization', 'Bearer {!$Api.Session_ID}');            
                                xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
                                console.log('BeforeSend:::');
                            },
                            success: function(response) {
                                // Sit the result to HTML div          
                                console.log('Success:::'+JSON.stringify(response));
                            },
                            error: function(jqXHR, textStatus, errorThrown) {
                                // Error
                                console.log('Error:::'+jqXHR.status + ': ' + errorThrown);
                            }
                        });
                    }
            //Added for site to community logic submission end
					
				}]);
            
            $(document).ready(function(){
                
            });
            
            //*** directive to show confirm box ***//
            myapp.directive('ngConfirmClick', [
                function(){
                    return {
                        link: function (scope, element, attr) {
                            var msg = attr.ngConfirmClick || "Are you sure?";
                            var clickAction = attr.confirmedClick;
                            element.bind('click',function (event) {
                                popup(msg, {'verify':true, 'animate':true}, function(r)
                                      {
                                          if(r) {
                                              scope.$eval(clickAction);
                                          }
                                      });
                            });
                        }
                    };
                }]);
                    
            //Shut down popup code
            var popupAlert = function(msg, truePart)
        {
            popup(msg, {'animate':true}, 
            function(r)
            {
                if(r && truePart != null)
                    truePart();                    
            });
            //  $(".aButtons button").html('{!$Label.TPA_OK}');
        }
            
            </script>
        </head>
        <body id="pageBody" style="background-image: url(/_slds/images/themes/lightning_blue/lightning_blue_background.png),linear-gradient(to top, rgba(160, 180, 206, 0.0) 0, rgba(160, 180, 206, 1.0)); background-repeat: no-repeat; min-height: 100vh">
            <div id="backWhiteOverlay" style="position:absolute;z-index:10000 !important;width:100%;height:100%;display:none;"></div>
            <c:VFC_TPA_LoadingImage />
            <apex:form id="theForm">
                <div id="ng-app" ng-app="AMARevisedOffshoreProcess">
                    <div id="controllerPage" ng-controller="controllerPage">
                        
                        <!-- AMA Offshore process for Client starts -->
                        <div style="margin:40px; background-color: white; border-radius: 5px;" id="block1" ng-if="rootObject.viewMode == 'offshore' && (rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  == 'Awaiting Vendor Response: AMA Offshore Consent form has been sent to Vendor' || rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  == 'Awaiting AMA Response: Offshore Consent form requires AMA review/approval')  && rootObject.offshoreErrorMessage =='' && rootObject.offshoreSuccessMessage== ''">
                            <apex:outputPanel >
                                <apex:pageBlock >
                                    <apex:pageblocksection collapsible="false" columns="1" >
                                        <div style="margin:40px;">
                                            
                                            <div ng-if="rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  == 'Awaiting Vendor Response: AMA Offshore Consent form has been sent to Vendor' && rootObject.type == 'VSubmit'">
                                                <p>The following is the AMA Offshore Consent Request Form.</p><br/>
                                                <p>ACTION: Please read carefully and populate “Section f” and your contact information at the bottom acknowledging the information contained in this request form is accurate.  {!$Label.TPA_IQVIA_Keyword} will provide the form to the AMA for their review and approval upon your submission.  You will be advised of approval or asked additional questions if necessary.</p><br/> <!-- //Modified by Neha Bansal under Issue-11410 -->
                                            </div>
                                            <div ng-if="rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  == 'Awaiting AMA Response: Offshore Consent form requires AMA review/approval' && rootObject.type == 'DBLSubmit'">
                                                
                                                <p> AMA ACTION REQUESTED: </p><br/>
                                                <p class="indent"> <span style="color: #FF7F00;">Step 1 – </span>Review </p>
                                                <p class="indent"> <span style="color: #FF7F00;">Step 2 – </span>Decision</p>
                                                <p class="indent"> <span style="color: #FF7F00;">Step 3 – </span>Submit to {!$Label.TPA_IQVIA_Keyword}</p><br/><br/> <!-- //Modified by Neha Bansal under Issue-11410 -->
                                                
                                                
                                                <p> <span style="color: #FF7F00;">Step 1:</span> Please review the IQVIA Third Party Request Related Details </p><br/>
                                                
                                                
                                            </div><br/>
											<div>
                                                <h5><b>{!$Label.TPA_IQVIA_Keyword} Third Party Request Related Details</b></h5>
                                                <br/>
                                                <pre><b>TPA Request:</b>  {{rootObject.TPA_Request_number}}</pre>
                                                <pre><b>Vendor Legal Name: </b>  {{rootObject.amaAgreementObj.Vendor_Legal_Name__c}}</pre>
                                                <pre><b>Client Company Name:</b>  {{rootObject.amaAgreementObj.Client__c}}</pre>
                                                <pre><b>Agreement Start Date:</b>  {{rootObject.amaAgreementObj.Agreement_Start_Date__c| date : "MM/dd/yyyy"}}</pre>
                                                <pre><b>Initial Termination Date:</b>  {{rootObject.amaAgreementObj.Initial_Termination_Date__c | date : "MM/dd/yyyy"}}</pre>
                                                <pre><b>Agreement End Date:</b>  {{rootObject.amaAgreementObj.Agreement_End_Date__c | date : "MM/dd/yyyy"}}</pre>
                                                <pre><b>AMA Variables Requested:</b>  {{getFormattedValue(rootObject.amaAgreementObj.AMA_TypeOfPrescriberLevelData__c)}}</pre>
                                                </div><br/>
                                            	<div>
                                                <h5><b>AMA Project Use(s):</b></h5><br/>
                                                <pre>{{getFormattedValue(rootObject.amaAgreementObj.AMA_Services_Provided__c)}}</pre>
                                                </div><br/>
                                            	<div>
                                                <pre><b>How long will Vendor have access to Data:</b>  {{rootObject.amaAgreementObj.AMA_Howlong_SP_has_Data_Access__c}}</pre>
                                                <pre><b>Offshore Remote Access Requested:</b>  {{rootObject.amaAgreementObj.Vendor_require_Remote_Access_from_NonUS__c}}</pre>
                                                <pre><b>Vendor Ex-U.S. Legal Entity For Remote Access:</b>  {{rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name_Remote_Access__c}}<span ng-if="rootObject.amaAgreementDetailObject.Vendor_require_Remote_Access_from_NonUS__c  == 'No'">N/A </span></pre>
                                                <pre><b>Third Party ‘Remote Access’ location(s) for Non-U.S. Location:</b>  {{rootObject.amaAgreementObj.Vendor_Employee_Accessed_Data_in_country__c}}<span ng-if="rootObject.amaAgreementDetailObject.Vendor_require_Remote_Access_from_NonUS__c  == 'No'">N/A </span></pre>
                                                <pre><b>Third Party secure ‘technology(s)’ that will be used for ‘Remote Access’:</b>  {{rootObject.amaAgreementObj.Technology_s_selected_for_remote_access__c}}<span ng-if="rootObject.amaAgreementDetailObject.Vendor_require_Remote_Access_from_NonUS__c  == 'No'">N/A </span></pre>
                                                <pre><b>Description of Other secure technology:</b>  {{rootObject.amaAgreementObj.Other_Technology_for_Remote_Access__c}}</pre>
                                                <pre><b>Offshore Storage Requested:</b>  {{rootObject.amaAgreementObj.Vendor_req_Storage_Permission_from_NonUS__c}}</pre>
                                                <pre><b>Vendor Ex-U.S. Legal Entity For Offshore Storage:</b>  {{rootObject.amaAgreementObj.Ex_US_Legal_Entity_Name_Offshore_Storage__c}}<span ng-if="rootObject.amaAgreementDetailObject.Vendor_req_Storage_Permission_from_NonUS__c  == 'No'">N/A </span></pre>
                                                <pre><b>Third Party ‘Storage’ location(s) for Non-U.S. Location:</b>  {{rootObject.amaAgreementObj.Vendor_Employee_Store_Data_in_country__c}}<span ng-if="rootObject.amaAgreementDetailObject.Vendor_req_Storage_Permission_from_NonUS__c  == 'No'">N/A </span></pre>
                                                </div><br/>
                                            
                                            <div ng-if="rootObject.viewMode == 'offshore' && rootObject.amaAgreementDetailObject.Status_of_Offshore_Process__c  == 'Awaiting AMA Response: Offshore Consent form requires AMA review/approval' && rootObject.type == 'DBLSubmit'">
                                                
                                                <p><span style="color: #FF7F00;">Step 2:</span> Please provide your decision or additional questions.</p><br/> 
                                                
                                                <p>AMA Please respond with your decision:</p><br/>
                                                
                                                
                                                <div style = "margin-left:10%;" >
                                                    <div style = "padding-top:5px;">
                                                        <div class="slds-checkbox">
                                                            <input id="Specified Offshore Consent request approved" type="checkbox" ng-model="rootObject.AMAResponseforOffshore" ng-true-value="request approved" />
                                                            <label class="slds-checkbox__label" for="Specified Offshore Consent request approved">
                                                                <span class="slds-checkbox_faux"></span>
                                                                <span class="slds-form-element__label">Specified Offshore Consent request approved</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div style = "padding-top:5px;"> 
                                                        <div class="slds-grid slds-grid_vertical">
                                                            <div class="slds-col">
                                                                <div class="slds-checkbox">
                                                                    <input id="Additional questions for Vendor requested by AMA:" type="checkbox" ng-model="rootObject.AMAResponseforOffshore" ng-true-value="Additional questions for Vendor" />
                                                                    <label class="slds-checkbox__label" for="Additional questions for Vendor requested by AMA:">
                                                                        <span class="slds-checkbox_faux"></span>
                                                                        <span class="slds-form-element__label">Additional questions for Vendor requested by AMA:</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <div class="slds-col">
                                                                <div class="slds-grid slds-size_1-of-2">
                                                                    <div class="slds-col slds-size_1-of-2">
                                                                        <span>Questions for Vendor Response: </span>
                                                                    </div>
                                                                    <div class="slds-col">
                                                                        <textarea type="text" rows="1" class="slds-textarea" ng-model="rootObject.amaAgreementObj.Questions_for_Vendor_Response__c" />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div style = "padding-top:5px;">
                                                        <div class="slds-grid slds-grid_vertical">
                                                            <div class="slds-col">
                                                                <div class="slds-checkbox">
                                                                    ​<input id="Offshore request not approved by AMA" type="checkbox" ng-model="rootObject.AMAResponseforOffshore" ng-true-value="not approved" />
                                                                    <label class="slds-checkbox__label" for="Offshore request not approved by AMA">
                                                                        <span class="slds-checkbox_faux"></span>
                                                                        <span class="slds-form-element__label">Offshore request not approved by AMA</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <div class="slds-col">
                                                                <div class="slds-grid slds-size_1-of-2">
                                                                    <div class="slds-col slds-size_1-of-2">
                                                                        <span>AMA reasons why: </span>
                                                                    </div>
                                                                    <div class="slds-col">
                                                                        <textarea type="text" class="slds-textarea" rows="1" ng-model="rootObject.amaAgreementObj.AMA_reasons_why_offshore_not_approved__c"/>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><br/>
                                                </div>
                                                <p><span style="color: #FF7F00;">Step 3:</span> Click “Submit” to notify {!$Label.TPA_IQVIA_Keyword} of your decision:</p><br/>  <!-- //Modified by Neha Bansal under Issue-11410 -->
                                                
                                            </div>
                                            <div style = "text-align:center;">
                                                <button class="btn btn-default slds-button slds-button_success" onclick="return false;" ng-show="rootObject.type == 'DBLSubmit'" ng-click="rootObject.saveAMAResponse();" ng-disabled="rootObject.isProcessing">Submit</button>
                                            </div><br/><br/>
                                            
                                        </div>
                                        
                                    </apex:pageBlockSection>
                                </apex:pageBlock>
                            </apex:outputPanel>
                            
                        </div>
                        
                        <!-- AMA Offshore process for Client ends-->
                        
                        <!-- Success Block for Success Message -->
                        <div style="margin:40px;" id="block3" ng-if="rootObject.viewMode == 'offshore' && rootObject.offshoreErrorMessage =='' && rootObject.offshoreSuccessMessage != '' ">
                            
                            <apex:outputPanel >
                                <apex:pageBlock >
                                    
                                    <!-- Success Message Box Start -->
                                    <div  ng-if="rootObject.offshoreSuccessMessage !='' " class="slds-theme_success slds-p-around_small">
                                        <div class="messageText slds-align_absolute-center">
                                            <h2 id= 'msg'>{{rootObject.offshoreSuccessMessage}}</h2>
                                        </div><br/>
                                    </div>
                                </apex:pageBlock>  
                            </apex:outputPanel>
                        </div>
                        <!-- Message Block for Offshore Success Process -->  
                        
                        
                        <!-- Message Block  for Offshore Process -->
                        <div class="slds-theme_error" ng-if="rootObject.offshoreErrorMessage !=''" style="margin:40px;">
                            <apex:outputPanel styleclass="slds-notify_container slds-is-relative ">
                                <apex:pageBlock >
                                    <!-- Error Message Box Start -->
                                    <div class="message errorM3 slds-notify__content " role="alert">
                                        <div class="slds-grid slds-grid_vertical slds-size_1-of-1 slds-p-around_small">
                                            <div class="slds-col">
                                                <div class="slds-grid">
                                                    <div class="slds-col slds-size_1-of-3"></div>
                                                    <div class="slds-col slds-size_1-of-3">
                                                        <h2 class="slds-text-heading_small">
                                                            <div class="messageText">
                                                                <span><h4>Errors</h4></span>
                                                            </div>
                                                        </h2>
                                                    </div>
                                                    <div class="slds-col slds-size_1-of-3"></div>
                                                </div>
                                            </div>
                                            <div class="slds-col">
                                                <div class="slds-grid">
                                                    <div class="slds-col slds-size_1-of-5"></div>
                                                    <div class="slds-col slds-size_1-of-5"></div>
                                                    <div class="slds-col slds-size_1-of-5">
                                                        <ul>
                                                            <li>{{rootObject.offshoreErrorMessage}}</li>
                                                        </ul>
                                                    </div>
                                                    <div class="slds-col slds-size_1-of-5"></div>
                                                    <div class="slds-col slds-size_1-of-5"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </apex:pageBlock>
                            </apex:outputPanel>
                        </div>
                        <!-- Message Block  for Offshore Process -->  
                        
                    </div>
                    <!-- AMA Cancelation Process --> 
                </div>
            </apex:form>
        </body>
    </html>
</apex:outputPanel>
    
</apex:page>